# This GitHub workflow will send notifications when the test workflow completes

name: notify

on:
  workflow_run:
    workflows:
      - test
    types:
      - completed

jobs:

  notify:
    runs-on: ubuntu-latest
    steps:

    - name: Display github.event.workflow_run properties
      run: |
        echo "event_name=${{ github.event.workflow_run.event_name }}"

    - name: Display github properties
      run: |
        echo "event_name=${{ github.event_name }}"

    - name: Post success to Slack (master)
      if: ${{ github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'master' }}
      run: |
        run_id=$(echo "${{ github.event.workflow_run.url }}" | rev | cut -d '/' -f 1 | rev)
        run_url="https://github.com/${{ github.repository }}/actions/runs/$run_id"
        branch="${{ github.event.workflow_run.head_branch }}"
        branch_url="https://github.com/${{ github.repository }}/pulls?q=head:$branch"
        json="{ \"text\": \":white_check_mark: Test workflow succeeded on ${{ github.repository }}: Run <$run_url|$run_id> on branch <$branch_url|$branch>\" }"
        curl -s -d "payload=$json" ${{ secrets.SLACK_HOOK }}

    - name: Post failure to Slack (master)
      if: ${{ github.event.workflow_run.conclusion == 'failure' && github.event.workflow_run.head_branch == 'master' }}
      run: |
        run_id=$(echo "${{ github.event.workflow_run.url }}" | rev | cut -d '/' -f 1 | rev)
        run_url="https://github.com/${{ github.repository }}/actions/runs/$run_id"
        branch="${{ github.event.workflow_run.head_branch }}"
        branch_url="https://github.com/${{ github.repository }}/pulls?q=head:$branch"
        json="{ \"text\": \":x: Test workflow failed on ${{ github.repository }}: Run <$run_url|$run_id> on branch <$branch_url|$branch>\" }"
        curl -s -d "payload=$json" ${{ secrets.SLACK_HOOK }}
