# This GitHub workflow will send notifications when the test workflow fails

name: notify

on:
  workflow_run:
    workflows:
      - test
    types:
      - completed

jobs:

#   on-success:
#     runs-on: ubuntu-latest
#     if: ${{ github.event.workflow_run.conclusion == 'success' }}
#     steps:
#       ...

  on-failure:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'failure' }}
    steps:

    - name: Debug - show workflow_run.head_branch
      run: |
        echo "head_branch=${{ github.event.workflow_run.head_branch }}"

    - name: Debug - show workflow_run.pull_requests[0]
      run: |
        echo "pull_requests[0]=${{ github.event.workflow_run.pull_requests[0] }}"

    - name: Debug - show workflow_run.url
      run: |
        echo "url=${{ github.event.workflow_run.url }}"

    - name: Debug - show workflow_run.external_id
      run: |
        echo "external_id=${{ github.event.workflow_run.external_id }}"

    - name: Debug - show workflow_run.details_url
      run: |
        echo "details_url=${{ github.event.workflow_run.details_url }}"

    - name: Debug - show actions run url
      run: |
        run_id=$(echo "${{ github.event.workflow_run.url }}" | rev | cut -d '/' -f 1 | rev)
        echo "https://github.com/pywbem/pywbem/actions/runs/$run_id"

    - name: Post failure to Slack
#      if: ${{ github.event_name == 'schedule' }}
      run: |
        json='{ "icon_emoji": ":thumbsdown:", "text": " ${{ github.repository }}: Scheduled test workflow failed" }'
        curl -s -d "payload=$json" ${{ secrets.SLACK_HOOK }}
